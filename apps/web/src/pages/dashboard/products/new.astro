---
// apps/web/src/pages/dashboard/products/new.astro
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { getLocaleFromCookie, t } from '../../../i18n/index.js';

const cookies = Astro.request.headers.get('cookie') ?? '';
const locale = getLocaleFromCookie(cookies);
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
---

<DashboardLayout title={t('products.new', locale)} activeNav="products">
  <div style="max-width:720px">
    <div id="error-msg" style="background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:0.875rem;border-radius:8px;margin-bottom:1rem;display:none"></div>

    <form id="product-form">
      <!-- Basic Info -->
      <div class="form-section">
        <h3 class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h3>
        <div class="form-group">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
          <input name="title" type="text" required maxlength="200" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="form-input" />
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
          <textarea name="description" rows="4" maxlength="5000" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù†ØªØ¬..." class="form-input" style="resize:vertical"></textarea>
        </div>
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬ (SKU)</label>
          <input name="sku" type="text" maxlength="100" placeholder="Ù…Ø«Ø§Ù„: PROD-001" class="form-input" style="font-family:monospace" />
        </div>
      </div>

      <!-- Pricing -->
      <div class="form-section">
        <h3 class="section-title">Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ *</label>
            <input name="price" type="number" required min="0" step="0.01" placeholder="0.00" class="form-input" />
          </div>
          <div class="form-group">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø®ØµÙ…</label>
            <input name="salePrice" type="number" min="0" step="0.01" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" class="form-input" />
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
            <select name="currency" class="form-input">
              <option value="MAD">MAD - Ø¯Ø±Ù‡Ù…</option>
              <option value="EUR">EUR - ÙŠÙˆØ±Ùˆ</option>
              <option value="USD">USD - Ø¯ÙˆÙ„Ø§Ø±</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
            <input name="stock" type="number" min="0" value="0" class="form-input" />
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select name="status" class="form-input">
              <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
              <option value="active">Ù†Ø´Ø·</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Categories -->
      <div class="form-section">
        <h3 class="section-title">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
        <div id="categories-container" style="display:flex;flex-wrap:wrap;gap:0.5rem;min-height:2rem">
          <span style="font-size:0.875rem;color:#94a3b8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
      </div>

      <!-- Images -->
      <div class="form-section">
        <h3 class="section-title">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</h3>
        <div
          id="drop-zone"
          style="border:2px dashed #e2e8f0;border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.15s"
          onclick="document.getElementById('file-input').click()"
        >
          <div style="font-size:2rem;margin-bottom:0.5rem">ğŸ“·</div>
          <p style="font-size:0.875rem;color:#64748b">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±ØŒ Ø£Ùˆ Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª</p>
          <p style="font-size:0.75rem;color:#94a3b8;margin-top:0.25rem">PNG, JPG, WebP â€” Ø­ØªÙ‰ 5MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©</p>
          <input type="file" id="file-input" multiple accept="image/*" style="display:none" />
        </div>
        <div id="images-preview" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.75rem"></div>
      </div>

      <!-- Actions -->
      <div style="display:flex;gap:0.75rem">
        <button type="submit" id="submit-btn" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        <a href="/dashboard/products" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
      </div>
    </form>
  </div>
</DashboardLayout>

<style>
  .form-section { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:1.5rem; margin-bottom:1rem; }
  .section-title { font-size:1rem; font-weight:600; margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:1px solid #f1f5f9; }
  .form-group { margin-bottom:0; }
  .form-group + .form-group { margin-top:1rem; }
  label { display:block; font-size:0.875rem; font-weight:500; margin-bottom:0.375rem; color:#374151; }
  .form-input { width:100%; padding:0.625rem 0.875rem; border:1.5px solid #e2e8f0; border-radius:8px; font-family:inherit; font-size:0.9rem; outline:none; transition:border-color 0.15s; }
  .form-input:focus { border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
  .btn-primary { background:#6366f1; color:#fff; padding:0.75rem 1.5rem; border:none; border-radius:8px; font-family:inherit; font-size:0.9rem; font-weight:600; cursor:pointer; }
  .btn-primary:hover:not(:disabled) { opacity:0.9; }
  .btn-primary:disabled { opacity:0.6; cursor:not-allowed; }
  .btn-secondary { background:#fff; color:#374151; padding:0.75rem 1.5rem; border:1px solid #e2e8f0; border-radius:8px; font-size:0.9rem; font-weight:600; }
  .cat-chip { padding:0.3rem 0.75rem; border-radius:100px; font-size:0.8rem; cursor:pointer; border:1.5px solid #e2e8f0; transition:all 0.15s; }
  .cat-chip.selected { background:#6366f1; color:#fff; border-color:#6366f1; }
</style>

<script define:vars={{ API_URL }}>
  const tenantSlug = localStorage.getItem('tenant_slug') ?? '';
  let selectedCategories = new Set();
  let pendingFiles = [];

  // Load categories
  fetch(`${API_URL}/store/categories`, {
    credentials: 'include',
    headers: { 'X-Tenant-Slug': tenantSlug },
  }).then(r => r.json()).then(data => {
    const cats = data.data ?? [];
    const container = document.getElementById('categories-container');
    if (!cats.length) {
      container.innerHTML = `<span style="font-size:0.875rem;color:#94a3b8">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª â€” <a href="/dashboard/categories" style="color:#6366f1">Ø£Ø¶Ù ØªØµÙ†ÙŠÙØ§Ù‹</a></span>`;
      return;
    }
    container.innerHTML = cats.map(c => `
      <button type="button" class="cat-chip" data-id="${c.id}" onclick="toggleCategory('${c.id}', this)">${c.name}</button>
    `).join('');
  }).catch(() => {});

  function toggleCategory(id, btn) {
    if (selectedCategories.has(id)) {
      selectedCategories.delete(id);
      btn.classList.remove('selected');
    } else {
      selectedCategories.add(id);
      btn.classList.add('selected');
    }
  }

  // Image preview
  document.getElementById('file-input').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    pendingFiles = [...pendingFiles, ...files];
    renderPreviews();
  });

  // Drag & drop
  const dz = document.getElementById('drop-zone');
  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.style.borderColor = '#6366f1'; });
  dz.addEventListener('dragleave', () => { dz.style.borderColor = '#e2e8f0'; });
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.style.borderColor = '#e2e8f0';
    pendingFiles = [...pendingFiles, ...Array.from(e.dataTransfer.files)];
    renderPreviews();
  });

  function renderPreviews() {
    const container = document.getElementById('images-preview');
    container.innerHTML = pendingFiles.map((f, i) => `
      <div style="position:relative;width:80px;height:80px">
        <img src="${URL.createObjectURL(f)}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e2e8f0" />
        <button type="button" onclick="removeFile(${i})" style="position:absolute;top:-6px;inset-inline-end:-6px;width:20px;height:20px;background:#ef4444;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:0.7rem;display:flex;align-items:center;justify-content:center">Ã—</button>
      </div>
    `).join('');
  }

  function removeFile(index) {
    pendingFiles.splice(index, 1);
    renderPreviews();
  }

  // Form submit
  document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const form = e.target;
    const errorMsg = document.getElementById('error-msg');
    btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    errorMsg.style.display = 'none';

    try {
      // 1. Create product
      const price = parseFloat(form.price.value);
      const salePrice = form.salePrice.value ? parseFloat(form.salePrice.value) : null;
      if (salePrice !== null && salePrice >= price) {
        errorMsg.textContent = 'Ø³Ø¹Ø± Ø§Ù„Ø®ØµÙ… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ';
        errorMsg.style.display = 'block';
        return;
      }

      const res = await fetch(`${API_URL}/dashboard/products`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Tenant-Slug': tenantSlug },
        credentials: 'include',
        body: JSON.stringify({
          title: form.title.value.trim(),
          description: form.description.value.trim() || undefined,
          sku: form.sku.value.trim() || undefined,
          price,
          salePrice,
          currency: form.currency.value,
          stock: parseInt(form.stock.value),
          status: form.status.value,
          categoryIds: [...selectedCategories],
        }),
      });

      const data = await res.json();
      if (!res.ok) {
        errorMsg.textContent = data.error ?? 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
        errorMsg.style.display = 'block';
        return;
      }

      // 2. Upload images
      if (pendingFiles.length > 0) {
        for (const file of pendingFiles) {
          const fd = new FormData();
          fd.append('file', file);
          fd.append('productId', data.id);
          await fetch(`${API_URL}/upload/product-image`, {
            method: 'POST',
            headers: { 'X-Tenant-Slug': tenantSlug },
            credentials: 'include',
            body: fd,
          }).catch(() => {});
        }
      }

      window.location.href = '/dashboard/products';

    } catch {
      errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
      errorMsg.style.display = 'block';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
    }
  });

  window.toggleCategory = toggleCategory;
  window.removeFile = removeFile;
</script>
