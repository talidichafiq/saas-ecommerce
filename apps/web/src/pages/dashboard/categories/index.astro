---
// apps/web/src/pages/dashboard/categories/index.astro
import DashboardLayout from '../../../layouts/DashboardLayout.astro';

const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
---

<DashboardLayout title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª" activeNav="categories">
  <div class="max-w-2xl">
    <!-- Add form -->
    <div class="bg-white rounded-xl border p-6 mb-6">
      <h3 class="font-semibold mb-4">Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="add-form" class="flex gap-3">
        <input type="text" id="cat-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ" class="flex-1 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" required />
        <input type="text" id="cat-slug" placeholder="slug" class="w-36 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary font-mono" required />
        <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
          Ø¥Ø¶Ø§ÙØ©
        </button>
      </form>
      <div id="form-error" class="hidden mt-2 text-sm text-red-500"></div>
    </div>

    <!-- List -->
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="loading" class="p-8 text-center text-muted-foreground text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div id="empty" class="hidden p-8 text-center text-muted-foreground">
        <div class="text-3xl mb-2">ğŸ—‚ï¸</div>
        <p class="text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø¨Ø¹Ø¯</p>
      </div>
      <ul id="categories-list"></ul>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  const tenantSlug = localStorage.getItem('tenant_slug');

  async function loadCategories() {
    const res = await fetch(`${API_URL}/store/categories`, { headers: { 'X-Tenant-Slug': tenantSlug }, credentials: 'include' });
    const data = await res.json();
    document.getElementById('loading').classList.add('hidden');

    if (!data.data?.length) {
      document.getElementById('empty').classList.remove('hidden');
      return;
    }

    document.getElementById('categories-list').innerHTML = data.data.map(cat => `
      <li class="flex items-center justify-between px-4 py-3 border-t first:border-t-0 hover:bg-muted/30">
        <div>
          <p class="text-sm font-medium">${cat.name}</p>
          <p class="text-xs font-mono text-muted-foreground">${cat.slug}</p>
        </div>
        <button onclick="deleteCategory('${cat.id}')" class="text-xs text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
      </li>
    `).join('');
  }

  // Auto-generate slug
  document.getElementById('cat-name').addEventListener('input', (e) => {
    document.getElementById('cat-slug').value = e.target.value
      .toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').slice(0, 50);
  });

  document.getElementById('add-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('cat-name').value;
    const slug = document.getElementById('cat-slug').value;
    const err = document.getElementById('form-error');
    err.classList.add('hidden');

    const res = await fetch(`${API_URL}/dashboard/categories`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Tenant-Slug': tenantSlug },
      body: JSON.stringify({ name, slug }),
    });
    const data = await res.json();
    if (!res.ok) { err.textContent = data.error ?? 'ÙØ´Ù„'; err.classList.remove('hidden'); return; }
    document.getElementById('cat-name').value = '';
    document.getElementById('cat-slug').value = '';
    loadCategories();
  });

  async function deleteCategory(id) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙØŸ')) return;
    await fetch(`${API_URL}/dashboard/categories/${id}`, {
      method: 'DELETE',
      headers: { 'X-Tenant-Slug': tenantSlug }, credentials: 'include'
    });
    loadCategories();
  }

  window.deleteCategory = deleteCategory;
  loadCategories();
</script>
