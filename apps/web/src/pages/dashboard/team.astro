---
// apps/web/src/pages/dashboard/team.astro
import DashboardLayout from '../../layouts/DashboardLayout.astro';
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
---

<DashboardLayout title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚" activeNav="team">
  <div class="max-w-2xl">
    <!-- Plan gate -->
    <div id="plan-gate" class="hidden bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl p-6 mb-6">
      <h3 class="font-bold text-lg mb-2">ğŸ”’ Ù…ÙŠØ²Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ù…ØªØ§Ø­Ø© ÙÙŠ Ø®Ø·Ø© Business</h3>
      <p class="text-sm opacity-90 mb-4">Ù‚Ù… Ø¨Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±ÙŠÙ‚ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
      <a href="/dashboard/billing" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold text-sm">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</a>
    </div>

    <!-- Invite form -->
    <div id="invite-section" class="hidden">
      <div class="bg-white rounded-xl border p-6 mb-6">
        <h3 class="font-semibold mb-4">Ø¯Ø¹ÙˆØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="flex gap-3">
          <input type="email" id="invite-email" placeholder="email@example.com" class="flex-1 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20" />
          <select id="invite-role" class="border rounded-lg px-3 py-2 text-sm focus:outline-none">
            <option value="staff">Ù…ÙˆØ¸Ù</option>
            <option value="admin">Ù…Ø¯ÙŠØ±</option>
          </select>
          <button onclick="inviteMember()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary/90">Ø¯Ø¹ÙˆØ©</button>
        </div>
        <div id="invite-error" class="hidden mt-2 text-sm text-red-500"></div>
        <p class="text-xs text-muted-foreground mt-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©</p>
      </div>

      <!-- Members list -->
      <div class="bg-white rounded-xl border overflow-hidden">
        <div class="px-6 py-4 border-b">
          <h3 class="font-semibold">Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</h3>
        </div>
        <div id="members-loading" class="p-8 text-center text-sm text-muted-foreground">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <ul id="members-list"></ul>
      </div>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
  const tenantId = localStorage.getItem('tenant_id');
  const tenantSlug = localStorage.getItem('tenant_slug');
  const plan = localStorage.getItem('tenant_plan');

  const roleLabels = { owner: 'Ù…Ø§Ù„Ùƒ', admin: 'Ù…Ø¯ÙŠØ±', staff: 'Ù…ÙˆØ¸Ù' };

  if (plan !== 'business') {
    document.getElementById('plan-gate').classList.remove('hidden');
  } else {
    document.getElementById('invite-section').classList.remove('hidden');
    loadMembers();
  }

  async function loadMembers() {
    try {
      const res = await fetch(`${API_URL}/tenants/${tenantId}/members`, {
        headers: { 'X-Tenant-Slug': tenantSlug }, credentials: 'include'
      });
      const data = await res.json();
      document.getElementById('members-loading').classList.add('hidden');

      document.getElementById('members-list').innerHTML = (data.data ?? []).map(m => `
        <li class="flex items-center justify-between px-6 py-4 border-t first:border-t-0">
          <div>
            <p class="font-medium text-sm">${m.user?.name ?? m.userId}</p>
            <p class="text-xs text-muted-foreground">${m.user?.email ?? ''}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full ${m.role === 'owner' ? 'bg-primary/10 text-primary' : m.role === 'admin' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">
            ${roleLabels[m.role] ?? m.role}
          </span>
        </li>
      `).join('');
    } catch {}
  }

  async function inviteMember() {
    const email = document.getElementById('invite-email').value;
    const role = document.getElementById('invite-role').value;
    const errorEl = document.getElementById('invite-error');
    errorEl.classList.add('hidden');

    try {
      const res = await fetch(`${API_URL}/tenants/${tenantId}/members`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Tenant-Slug': tenantSlug },
        body: JSON.stringify({ email, role }),
      });
      const data = await res.json();
      if (!res.ok) { errorEl.textContent = data.error ?? 'ÙØ´Ù„'; errorEl.classList.remove('hidden'); return; }
      document.getElementById('invite-email').value = '';
      loadMembers();
    } catch {}
  }

  window.inviteMember = inviteMember;
</script>
