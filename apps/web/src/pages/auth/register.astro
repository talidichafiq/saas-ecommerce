---
// apps/web/src/pages/auth/register.astro
import { getLocaleFromCookie, t, isRTL } from '../../i18n/index.js';
const cookies = Astro.request.headers.get('cookie') ?? '';
const locale = getLocaleFromCookie(cookies);
const dir = isRTL(locale) ? 'rtl' : 'ltr';
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
---

<!DOCTYPE html>
<html lang={locale} dir={dir}>
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{t('auth.register', locale)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Cairo', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; }
    .card { background: white; border-radius: 16px; padding: 2rem; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    h1 { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.25rem; }
    .subtitle { text-align: center; color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.375rem; }
    input { width: 100%; padding: 0.625rem 0.875rem; border: 1.5px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.15s; }
    input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .password-hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }
    .btn { width: 100%; padding: 0.75rem; background: #6366f1; color: white; border: none; border-radius: 8px; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .error-msg { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
    .info-msg { background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
    .links { text-align: center; margin-top: 1rem; font-size: 0.875rem; }
    .links a { color: #6366f1; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸš€ {t('auth.register', locale)}</h1>
    <p class="subtitle">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØ§Ø¨Ø¯Ø£ Ù…ØªØ¬Ø±Ùƒ</p>
    <div class="error-msg" id="error-msg"></div>
    <div class="info-msg" id="info-msg"></div>
    <form id="register-form">
      <div class="form-group">
        <label for="name">{t('auth.name', locale)}</label>
        <input type="text" id="name" required placeholder="Ù…Ø­Ù…Ø¯ Ø£Ù…ÙŠÙ†" autocomplete="name" minlength="2" />
      </div>
      <div class="form-group">
        <label for="email">{t('auth.email', locale)}</label>
        <input type="email" id="email" required placeholder="you@example.com" autocomplete="email" />
      </div>
      <div class="form-group">
        <label for="password">{t('auth.password', locale)}</label>
        <input type="password" id="password" required autocomplete="new-password" minlength="8" />
        <p class="password-hint">8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
      </div>
      <button type="submit" class="btn" id="submit-btn">{t('auth.register', locale)}</button>
    </form>
    <div class="links">
      <span>Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ </span><a href="/auth/login">{t('auth.login', locale)}</a>
    </div>
  </div>

  <script define:vars={{ API_URL, locale }}>
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const errorMsg = document.getElementById('error-msg');
      const infoMsg = document.getElementById('info-msg');
      btn.disabled = true; btn.textContent = '...';
      errorMsg.style.display = 'none'; infoMsg.style.display = 'none';

      try {
        const res = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          errorMsg.textContent = data.error ?? 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
          errorMsg.style.display = 'block';
          return;
        }

        // Cache user info (non-sensitive)
        localStorage.setItem('auth_user', JSON.stringify(data.user));

        // Show email verification hint
        infoMsg.textContent = data.message ?? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ù„ØªÙØ¹ÙŠÙ„.';
        infoMsg.style.display = 'block';

        setTimeout(() => { window.location.href = '/auth/onboarding'; }, 1500);

      } catch {
        errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        errorMsg.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = locale === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'Register';
      }
    });
  </script>
</body>
</html>
