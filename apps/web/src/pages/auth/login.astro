---
// apps/web/src/pages/auth/login.astro
import { getLocaleFromCookie, t, isRTL } from '../../i18n/index.js';
const cookies = Astro.request.headers.get('cookie') ?? '';
const locale = getLocaleFromCookie(cookies);
const dir = isRTL(locale) ? 'rtl' : 'ltr';
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
---

<!DOCTYPE html>
<html lang={locale} dir={dir}>
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{t('auth.login', locale)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Cairo', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; }
    .card { background: white; border-radius: 16px; padding: 2rem; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .brand { text-align: center; margin-bottom: 1.5rem; }
    .brand-icon { font-size: 2.5rem; }
    h1 { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.25rem; }
    .subtitle { text-align: center; color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.375rem; }
    input { width: 100%; padding: 0.625rem 0.875rem; border: 1.5px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.15s; }
    input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .btn { width: 100%; padding: 0.75rem; background: #6366f1; color: white; border: none; border-radius: 8px; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.15s; margin-top: 0.5rem; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .error-msg { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
    .links { text-align: center; margin-top: 1rem; font-size: 0.875rem; }
    .links a { color: #6366f1; text-decoration: none; }
    .links a:hover { text-decoration: underline; }
    .divider { margin: 0.5rem 0; color: #9ca3af; }
  </style>
</head>
<body>
  <div class="card">
    <div class="brand"><div class="brand-icon">ğŸª</div></div>
    <h1>{t('auth.login', locale)}</h1>
    <p class="subtitle">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <div class="error-msg" id="error-msg"></div>
    <form id="login-form">
      <div class="form-group">
        <label for="email">{t('auth.email', locale)}</label>
        <input type="email" id="email" name="email" required placeholder="you@example.com" autocomplete="email" />
      </div>
      <div class="form-group">
        <label for="password">
          <span>{t('auth.password', locale)}</span>
          <a href="/auth/forgot" style="float:var(--end, left);font-size:0.8rem;color:#6366f1;font-weight:400">{t('auth.forgot', locale)}</a>
        </label>
        <input type="password" id="password" name="password" required autocomplete="current-password" />
      </div>
      <button type="submit" class="btn" id="submit-btn">{t('auth.login', locale)}</button>
    </form>
    <div class="links">
      <span class="divider">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span>
      <a href="/auth/register">{t('auth.register', locale)}</a>
    </div>
  </div>

  <script define:vars={{ API_URL, locale }}>
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const errorMsg = document.getElementById('error-msg');
      btn.disabled = true;
      btn.textContent = '...';
      errorMsg.style.display = 'none';

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',  // âœ… Receive HttpOnly session cookie
          body: JSON.stringify({
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          errorMsg.textContent = data.error ?? (locale === 'ar' ? 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Login failed');
          errorMsg.style.display = 'block';
          return;
        }

        // âœ… NO token stored â€” session is in HttpOnly cookie
        // Only cache non-sensitive UI state
        localStorage.setItem('auth_user', JSON.stringify(data.user));
        if (data.tenant) {
          localStorage.setItem('tenant_id', data.tenant.id);
          localStorage.setItem('tenant_slug', data.tenant.slug);
          localStorage.setItem('tenant_role', data.tenant.role);
          localStorage.setItem('tenant_plan', data.tenant.plan);
          if (data.tenant.name) localStorage.setItem('tenant_name', data.tenant.name);
        }

        const redirect = new URLSearchParams(window.location.search).get('redirect') ?? '/dashboard';
        window.location.href = data.tenant ? redirect : '/auth/onboarding';

      } catch {
        errorMsg.textContent = locale === 'ar' ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error';
        errorMsg.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = locale === 'ar' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Login';
      }
    });
  </script>
</body>
</html>
