---
// apps/web/src/pages/store/success.astro
import StorefrontLayout from '../../layouts/StorefrontLayout.astro';
import { getLocaleFromCookie } from '../../i18n/index.js';

const cookies = Astro.request.headers.get('cookie') ?? '';
const locale = getLocaleFromCookie(cookies);
const url = new URL(Astro.request.url);
const orderId = url.searchParams.get('order_id');
const isCod = url.searchParams.get('method') === 'cod';
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
const host = Astro.request.headers.get('host') ?? '';
const tenantSlug = host.split('.')[0];

let order: any = null;
if (orderId) {
  try {
    const res = await fetch(`${API_URL}/store/orders/${orderId}`, {
      headers: { 'X-Tenant-Slug': tenantSlug },
    });
    if (res.ok) order = await res.json();
  } catch {}
}

const isAr = locale === 'ar';
const title = isAr ? 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰' : 'Order Placed! ğŸ‰';
---

<StorefrontLayout title={title}>
  <div style="max-width:500px;margin:0 auto;padding:4rem 1rem;text-align:center">
    <div style="background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:2.5rem;box-shadow:0 4px 24px rgba(0,0,0,0.06)">

      <!-- Icon: different for COD vs Stripe -->
      <div style="font-size:4rem;margin-bottom:1.25rem">{isCod ? 'ğŸ ' : 'ğŸ‰'}</div>

      <h1 style="font-size:1.5rem;font-weight:700;margin-bottom:0.5rem">
        {isAr ? 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ!' : 'Thank you for your order!'}
      </h1>

      <p style="color:#64748b;margin-bottom:1.5rem;line-height:1.6">
        {isCod
          ? (isAr
              ? 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„.'
              : 'Your order has been received. We will contact you soon to confirm delivery.')
          : (isAr
              ? 'ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†ÙØ¹Ø¯Ù‘ Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.'
              : 'Payment successful. We will prepare your order shortly.')
        }
      </p>

      <!-- COD notice banner -->
      {isCod && (
        <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:0.875rem 1rem;margin-bottom:1.25rem;text-align:start">
          <p style="font-size:0.8rem;color:#92400e;font-weight:600;margin-bottom:0.25rem">
            {isAr ? 'â„¹ï¸ ØªØ°ÙƒÙŠØ± â€” Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'â„¹ï¸ Reminder â€” Cash on Delivery'}
          </p>
          <p style="font-size:0.8rem;color:#92400e">
            {isAr
              ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ!'
              : 'Please have the exact amount ready when your order arrives. Thank you!'}
          </p>
        </div>
      )}

      <!-- Order details card -->
      {order && (
        <div style="background:#f8fafc;border-radius:12px;padding:1.25rem;text-align:start;margin-bottom:1.25rem">
          <p style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;color:#334155">
            {isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨' : 'Order Details'}
          </p>

          <div style="display:flex;flex-direction:column;gap:0.5rem">
            <div style="display:flex;justify-content:space-between;font-size:0.8rem">
              <span style="color:#64748b">{isAr ? 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨' : 'Order ID'}</span>
              <span style="font-family:monospace;font-weight:600">#{order.id.slice(-8).toUpperCase()}</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.8rem">
              <span style="color:#64748b">{isAr ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : 'Email'}</span>
              <span>{order.customerEmail}</span>
            </div>
            {order.customerPhone && (
              <div style="display:flex;justify-content:space-between;font-size:0.8rem">
                <span style="color:#64748b">{isAr ? 'Ø§Ù„Ù‡Ø§ØªÙ' : 'Phone'}</span>
                <span>{order.customerPhone}</span>
              </div>
            )}
            <div style="display:flex;justify-content:space-between;font-size:0.8rem">
              <span style="color:#64748b">{isAr ? 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹' : 'Payment'}</span>
              <span style={`font-weight:600;color:${order.paymentMethod === 'COD' ? '#92400e' : '#065f46'}`}>
                {order.paymentMethod === 'COD'
                  ? (isAr ? 'ğŸ  Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'ğŸ  Cash on Delivery')
                  : (isAr ? 'ğŸ’³ Ø¨Ø·Ø§Ù‚Ø©' : 'ğŸ’³ Card')}
              </span>
            </div>
            <div style="border-top:1px solid #e2e8f0;padding-top:0.5rem;display:flex;justify-content:space-between;font-size:0.9rem">
              <span style="font-weight:600">{isAr ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}</span>
              <span style="font-weight:700;color:#6366f1">{order.total.toFixed(2)} {order.currency}</span>
            </div>
          </div>

          {order.items && order.items.length > 0 && (
            <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px dashed #e2e8f0;display:flex;flex-direction:column;gap:0.375rem">
              {order.items.map((item: any) => (
                <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#64748b">
                  <span>{item.titleSnapshot} Ã— {item.qty}</span>
                  <span>{(item.priceSnapshot * item.qty).toFixed(2)}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      <!-- CTAs -->
      <div style="display:flex;flex-direction:column;gap:0.625rem">
        <a href="/" style="background:#6366f1;color:#fff;padding:0.75rem;border-radius:10px;font-weight:600;font-size:0.875rem;text-decoration:none;display:block">
          {isAr ? 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±' : 'Back to Store'}
        </a>
        <a href="/catalog" style="border:1px solid #e2e8f0;color:#475569;padding:0.75rem;border-radius:10px;font-size:0.875rem;text-decoration:none;display:block">
          {isAr ? 'Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚' : 'Continue Shopping'}
        </a>
      </div>

    </div>
  </div>
</StorefrontLayout>
