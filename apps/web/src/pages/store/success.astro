---
// apps/web/src/pages/store/success.astro
import StorefrontLayout from '../../layouts/StorefrontLayout.astro';
import { getLocaleFromCookie } from '../../i18n/index.js';

const cookies = Astro.request.headers.get('cookie') ?? '';
const locale = getLocaleFromCookie(cookies);
const url = new URL(Astro.request.url);
const orderId = url.searchParams.get('order_id');
const API_URL = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787';
const host = Astro.request.headers.get('host') ?? '';
const tenantSlug = host.split('.')[0];

let order: any = null;
if (orderId) {
  try {
    const res = await fetch(`${API_URL}/store/orders/${orderId}`, {
      headers: { 'X-Tenant-Slug': tenantSlug }
    });
    if (res.ok) order = await res.json();
  } catch {}
}
---

<StorefrontLayout title="ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰">
  <div class="container py-16 max-w-lg text-center">
    <div class="bg-white rounded-2xl border shadow-sm p-10">
      <div class="text-6xl mb-6">ğŸ‰</div>
      <h1 class="text-2xl font-bold mb-2">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ!</h1>
      <p class="text-muted-foreground mb-6">
        {order ? `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.` : 'ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.'}
      </p>

      {order && (
        <div class="bg-muted/50 rounded-xl p-5 text-start mb-6">
          <p class="text-sm font-medium mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</p>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
              <span class="font-mono font-medium">#{order.id.slice(-8).toUpperCase()}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
              <span>{order.customerEmail}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
              <span class="font-bold text-primary">{order.total} {order.currency}</span>
            </div>
          </div>
          {order.items && (
            <div class="mt-3 pt-3 border-t space-y-1">
              {order.items.map((item: any) => (
                <div class="flex justify-between text-xs text-muted-foreground">
                  <span>{item.titleSnapshot} Ã— {item.qty}</span>
                  <span>{(item.priceSnapshot * item.qty).toFixed(2)}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      <div class="flex flex-col gap-3">
        <a href="/" class="bg-primary text-white py-3 rounded-xl font-semibold hover:bg-primary/90 transition-colors">
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
        </a>
        <a href="/catalog" class="border py-3 rounded-xl font-medium hover:bg-muted transition-colors text-sm">
          Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚
        </a>
      </div>
    </div>
  </div>
</StorefrontLayout>
